const fs = require("fs");
const cfg = require("./cfg.json");
const {name} = require("../../package.json");
const config = require("./build.json");

/** 调试配置 **/
cfg.port = 3345; //本地调试渲染进程端口

/**  config配置  **/
config.productName = name;
config.nsis.shortcutName = name;
config.appId = `org.${name}`;
config.npmRebuild = true; //是否Rebuild编译
config.asar = true;//是否asar打包
config.nsis.allowToChangeInstallationDirectory = true;//是否允许用户修改安装为位置
config.publish = [{ //更新地址
    provider: "generic",
    url: "http://127.0.0.1:3000/"
}];
let nConf = {
    "appPort": cfg.port,
    "appUrl": "http://127.0.0.1:3000/", //程序主访问地址
    "socketUrl": "http://127.0.0.1:3000/",// 程序socket访问地址
    "updateFileUrl": "http://127.0.0.1:3000/public/kl/", //更新文件地址
    "updaterCacheDirName": `${name.toLowerCase()}-updater` //更新文件名称
};

/** win打包配置 */
config.win.requestedExecutionLevel = ["asInvoker", "highestAvailable"][0]; //应用权限
config.win.target = [];
config.win.target.push({ //单文件
    "target": "portable"
    // "arch": ["x64"]
});
config.win.target.push({ //nsis打包
    "target": "nsis"
    // "arch": ["x64"]
});
let nsh = "";
if (config.nsis.allowToChangeInstallationDirectory) {
    nsh = "!macro customHeader\n" +
        "\n" +
        "!macroend\n" +
        "\n" +
        "!macro preInit\n" +
        "\n" +
        "!macroend\n" +
        "\n" +
        "!macro customInit\n" +
        "    ReadRegStr $0 HKLM \"Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\" \"UninstallString\"\n" +
        "    ${If} $0 != \"\"\n" +
        "       # ExecWait $0 $1\n" +
        "    ${EndIf}\n" +
        "!macroend\n" +
        "\n" +
        "!macro customInstall\n" +
        "\n" +
        "!macroend\n" +
        "\n" +
        "!macro customInstallMode\n" +
        "   # set $isForceMachineInstall or $isForceCurrentInstall\n" +
        "   # to enforce one or the other modes.\n" +
        "   #set $isForceMachineInstall\n" +
        "!macroend";
} else {
    nsh = "; Script generated by the HM NIS Edit Script Wizard.\n" +
        "\n" +
        "; HM NIS Edit Wizard helper defines custom install default dir\n" +
        "!macro preInit\n" +
        "    SetRegView 64\n" +
        "    WriteRegExpandStr HKLM \"${INSTALL_REGISTRY_KEY}\" InstallLocation \"$LOCALAPPDATA\\" + name + "\"\n" +
        "    WriteRegExpandStr HKCU \"${INSTALL_REGISTRY_KEY}\" InstallLocation \"$LOCALAPPDATA\\" + name + "\"\n" +
        "    SetRegView 32\n" +
        "    WriteRegExpandStr HKLM \"${INSTALL_REGISTRY_KEY}\" InstallLocation \"$LOCALAPPDATA\\" + name + "\"\n" +
        "    WriteRegExpandStr HKCU \"${INSTALL_REGISTRY_KEY}\" InstallLocation \"$LOCALAPPDATA\\" + name + "\"\n" +
        "!macroend";
}

/** linux配置 **/
config.linux.target = ["AppImage", "snap", "deb", "rpm", "pacman"][4];
config.linux.executableName = name;

fs.writeFileSync("./resources/script/cfg.json", JSON.stringify(cfg));
fs.writeFileSync("./resources/script/build.json", JSON.stringify(config, null, 2));
fs.writeFileSync("./resources/script/installer.nsh", nsh);
fs.writeFileSync("./src/lib/cfg/config.json", JSON.stringify(nConf, null, 2));
